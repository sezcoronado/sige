// src/controllers/tareas.controller.js
const { ErrorFactory } = require('../utils/errors.util');

// Mock de Tareas (Asignaciones)
let MOCK_TAREAS = [
  {
    id: 'tsk_001',
    titulo: 'Problemas de fracciones',
    descripcion: 'Resolver los ejercicios 1-15 del libro página 45',
    materia: 'Matemáticas',
    docenteId: 'tchr_12345',
    fechaAsignacion: '2025-10-28T08:00:00Z',
    fechaEntrega: '2025-11-05T23:59:59Z',
  },
  {
    id: 'tsk_002',
    titulo: 'Investigación sobre el sistema solar',
    descripcion: 'Realizar investigación de 2 páginas sobre los planetas',
    materia: 'Ciencias Naturales',
    docenteId: 'tchr_12345',
    fechaAsignacion: '2025-10-25T08:00:00Z',
    fechaEntrega: '2025-11-03T23:59:59Z',
  },
  {
    id: 'tsk_003',
    titulo: 'Ensayo sobre "Cien años de soledad"',
    descripcion: 'Escribir un ensayo de 3 páginas analizando los temas principales de la novela.',
    materia: 'Español',
    docenteId: 'tchr_12345',
    fechaAsignacion: '2025-10-20T08:00:00Z',
    fechaEntrega: '2025-11-10T23:59:59Z',
  },
  {
    id: 'tsk_004',
    titulo: 'Línea de tiempo de la Revolución Mexicana',
    descripcion: 'Crear una línea de tiempo visual con los 10 eventos más importantes de la Revolución Mexicana.',
    materia: 'Historia',
    docenteId: 'tchr_12345',
    fechaAsignacion: '2025-11-01T08:00:00Z',
    fechaEntrega: '2025-11-15T23:59:59Z',
  },
  {
    id: 'tsk_005',
    titulo: 'Dibujo a lápiz de un bodegón',
    descripcion: 'Realizar un dibujo a lápiz de un bodegón con al menos 3 frutas, prestando atención a luces y sombras.',
    materia: 'Arte',
    docenteId: 'tchr_12345',
    fechaAsignacion: '2025-10-29T08:00:00Z',
    fechaEntrega: '2025-11-08T23:59:59Z',
  },
  {
    id: 'tsk_006',
    titulo: 'Ejercicios de Álgebra',
    descripcion: 'Resolver la hoja de ejercicios de ecuaciones de segundo grado.',
    materia: 'Matemáticas',
    docenteId: 'tchr_12345',
    fechaAsignacion: '2025-10-15T08:00:00Z',
    fechaEntrega: '2025-10-22T23:59:59Z',
  },
  {
    id: 'tsk_007',
    titulo: 'Reporte de laboratorio: La célula',
    descripcion: 'Elaborar un reporte del laboratorio sobre la observación de células animales y vegetales.',
    materia: 'Ciencias Naturales',
    docenteId: 'tchr_12345',
    fechaAsignacion: '2025-10-18T08:00:00Z',
    fechaEntrega: '2025-10-25T23:59:59Z',
  },
  {
    id: 'tsk_008',
    titulo: 'Análisis de un poema de Octavio Paz',
    descripcion: 'Leer el poema "Piedra de Sol" y escribir un análisis de una página sobre su estructura y significado.',
    materia: 'Español',
    docenteId: 'tchr_12345',
    fechaAsignacion: '2025-11-04T08:00:00Z',
    fechaEntrega: '2025-11-12T23:59:59Z',
  },
  {
    id: 'tsk_009',
    titulo: 'Resumen del descubrimiento de América',
    descripcion: 'Escribir un resumen de 500 palabras sobre los viajes de Cristóbal Colón y el descubrimiento de América.',
    materia: 'Historia',
    docenteId: 'tchr_12345',
    fechaAsignacion: '2025-10-27T08:00:00Z',
    fechaEntrega: '2025-11-04T23:59:59Z',
  },
];

// Mock de Entregas (Submissions)
let MOCK_ENTREGAS = [
  // Entregas Alumno 1
  { id: 'ent_001', tareaId: 'tsk_002', alumnoId: 'stdnt_alumno01', estado: 'entregada', archivoEntrega: 'uploads/tareas/tarea-1234567890-sistema-solar.pdf', fechaEntregaAlumno: '2025-11-02T18:30:00Z', calificacion: null, comentarioDocente: null },
  { id: 'ent_002', tareaId: 'tsk_005', alumnoId: 'stdnt_alumno01', estado: 'entregada', archivoEntrega: 'uploads/tareas/tarea-bodegon.jpg', fechaEntregaAlumno: '2025-11-07T15:00:00Z', calificacion: null, comentarioDocente: null },
  { id: 'ent_003', tareaId: 'tsk_006', alumnoId: 'stdnt_alumno01', estado: 'calificada', archivoEntrega: 'uploads/tareas/tarea-algebra.pdf', fechaEntregaAlumno: '2025-10-21T20:00:00Z', calificacion: 95, comentarioDocente: 'Excelente trabajo, muy bien resueltos los problemas. Sigue así.' },
  { id: 'ent_004', tareaId: 'tsk_007', alumnoId: 'stdnt_alumno01', estado: 'calificada', archivoEntrega: 'uploads/tareas/tarea-celula.docx', fechaEntregaAlumno: '2025-10-25T10:15:00Z', calificacion: 80, comentarioDocente: 'Buen reporte, pero faltó detallar más las conclusiones y citar las fuentes correctamente.' },
  { id: 'ent_005', tareaId: 'tsk_009', alumnoId: 'stdnt_alumno01', estado: 'entregada', archivoEntrega: 'uploads/tareas/tarea-colon.pdf', fechaEntregaAlumno: '2025-11-03T22:00:00Z', calificacion: null, comentarioDocente: null },
  // Entregas Alumno 2
  { id: 'ent_006', tareaId: 'tsk_006', alumnoId: 'stdnt_alumno02', estado: 'calificada', archivoEntrega: 'uploads/tareas/tarea-algebra-mateo.pdf', fechaEntregaAlumno: '2025-10-22T10:00:00Z', calificacion: 88, comentarioDocente: 'Buen trabajo, Mateo. Revisa el ejercicio 5.' },
  { id: 'ent_007', tareaId: 'tsk_007', alumnoId: 'stdnt_alumno02', estado: 'calificada', archivoEntrega: 'uploads/tareas/tarea-celula-mateo.docx', fechaEntregaAlumno: '2025-10-24T18:00:00Z', calificacion: 92, comentarioDocente: 'Muy buen reporte, excelentes conclusiones.' },
  { id: 'ent_008', tareaId: 'tsk_002', alumnoId: 'stdnt_alumno02', estado: 'entregada', archivoEntrega: 'uploads/tareas/tarea-sistemasolar-mateo.pdf', fechaEntregaAlumno: '2025-11-01T14:20:00Z', calificacion: null, comentarioDocente: null },
];

/**
 * Listar tareas
 */
const getTareas = async (req, res, next) => {
  try {
    const { alumnoId, estado, materia, page = 1, pageSize = 20 } = req.query;
    const userRol = req.user.rol;
    const userId = req.user.id;
    const targetAlumnoId = userRol === 'alumno' ? userId : alumnoId;

    if (!targetAlumnoId && userRol !== 'docente') {
      throw ErrorFactory.badRequest('El parámetro alumnoId es requerido');
    }

    let tareasResult = MOCK_TAREAS.map(tarea => {
      const entrega = MOCK_ENTREGAS.find(e => e.tareaId === tarea.id && e.alumnoId === targetAlumnoId);
      return {
        ...tarea,
        estado: entrega ? entrega.estado : 'pendiente',
        calificacion: entrega ? entrega.calificacion : null,
        comentarioDocente: entrega ? entrega.comentarioDocente : null,
        archivoEntrega: entrega ? entrega.archivoEntrega : null,
        fechaEntregaAlumno: entrega ? entrega.fechaEntregaAlumno : null,
      };
    });

    // Filtrar por estado
    if (estado) {
      tareasResult = tareasResult.filter(t => t.estado === estado);
    }

    // Filtrar por materia
    if (materia) {
      tareasResult = tareasResult.filter(t => t.materia === materia);
    }

    // Ordenar por fecha de entrega
    tareasResult.sort((a, b) => new Date(a.fechaEntrega) - new Date(b.fechaEntrega));

    // Paginación
    const start = (page - 1) * pageSize;
    const end = start + parseInt(pageSize);
    const paginatedItems = tareasResult.slice(start, end);

    res.status(200).json({
      total: tareasResult.length,
      page: parseInt(page),
      pageSize: parseInt(pageSize),
      items: paginatedItems
    });
  } catch (error) {
    next(error);
  }
};

/**
 * Obtener detalle de una tarea
 */
const getTareaById = async (req, res, next) => {
  try {
    const { tareaId } = req.params;
    const { alumnoId } = req.query;
    const userId = req.user.id;
    const userRol = req.user.rol;
    const targetAlumnoId = userRol === 'alumno' ? userId : alumnoId;

    const tarea = MOCK_TAREAS.find(t => t.id === tareaId);

    if (!tarea) {
      throw ErrorFactory.notFound('Tarea');
    }

    const entrega = MOCK_ENTREGAS.find(e => e.tareaId === tarea.id && e.alumnoId === targetAlumnoId);

    res.status(200).json({
      ...tarea,
      ...(entrega && { ...entrega }) // Fusiona los datos de la entrega si existe
    });

  } catch (error) {
    next(error);
  }
};

/**
 * Entregar tarea (con archivo)
 */
const entregarTarea = async (req, res, next) => {
  try {
    const { tareaId } = req.params;
    const { comentario } = req.body;
    const userId = req.user.id;
    const archivo = req.file;

    // Validar que se subió un archivo
    if (!archivo) {
      throw ErrorFactory.badRequest('Debe subir un archivo', [
        { campo: 'archivo', error: 'Archivo requerido' }
      ]);
    }

    // Buscar tarea
    const tarea = MOCK_TAREAS.find(t => t.id === tareaId);

    if (!tarea) {
      throw ErrorFactory.notFound('Tarea');
    }

    // Buscar si ya existe una entrega
    let entrega = MOCK_ENTREGAS.find(e => e.tareaId === tareaId && e.alumnoId === userId);

    if (entrega && (entrega.estado === 'entregada' || entrega.estado === 'calificada')) {
      throw ErrorFactory.badRequest('Esta tarea ya fue entregada');
    }

    // Validar que no esté vencida
    const fechaEntrega = new Date(tarea.fechaEntrega);
    const ahora = new Date();
    if (ahora > fechaEntrega) {
      throw ErrorFactory.badRequest('La fecha de entrega ha expirado');
    }

    // Crear o actualizar entrega
    const datosEntrega = {
      id: `ent_${Date.now()}`,
      tareaId: tarea.id,
      alumnoId: userId,
      estado: 'entregada',
      archivoEntrega: archivo.path,
      fechaEntregaAlumno: new Date().toISOString(),
      comentarioAlumno: comentario || null,
    };

    MOCK_ENTREGAS.push(datosEntrega);

    res.status(200).json({
      mensaje: 'Tarea entregada exitosamente',
      entrega: entrega,
      tarea: tarea
    });
  } catch (error) {
    next(error);
  }
};

/**
 * Calificar tarea entregada
 */
const calificarTarea = async (req, res, next) => {
  try {
    const { tareaId } = req.params;
    const { alumnoId, calificacion, comentario } = req.body;

    // Validaciones
    if (!alumnoId || calificacion === undefined || calificacion === null) {
      const detalles = [];
      if (!alumnoId) detalles.push({ campo: 'alumnoId', error: 'Campo requerido' });
      if (calificacion === undefined || calificacion === null) {
        detalles.push({ campo: 'calificacion', error: 'Campo requerido' });
      }
      throw ErrorFactory.badRequest('Datos incompletos', detalles);
    }

    // Validar rango de calificación
    if (calificacion < 0 || calificacion > 100) {
      throw ErrorFactory.badRequest('La calificación debe estar entre 0 y 100', [
        { campo: 'calificacion', error: 'Debe ser un número entre 0 y 100' }
      ]);
    }

    // Buscar entrega
    const entrega = MOCK_ENTREGAS.find(e => e.tareaId === tareaId && e.alumnoId === alumnoId);

    if (!entrega) {
      throw ErrorFactory.notFound('La entrega para este alumno y tarea no fue encontrada');
    }

    // Validar que esté entregada
    if (entrega.estado !== 'entregada') {
      throw ErrorFactory.badRequest('Solo se pueden calificar tareas entregadas');
    }

    // Actualizar calificación
    entrega.estado = 'calificada';
    entrega.calificacion = calificacion;
    entrega.comentarioDocente = comentario || null;

    res.status(200).json({
      mensaje: 'Tarea calificada exitosamente',
      tarea: tarea
    });
  } catch (error) {
    next(error);
  }
};

module.exports = {
  getTareas,
  getTareaById,
  entregarTarea,
  calificarTarea
};
